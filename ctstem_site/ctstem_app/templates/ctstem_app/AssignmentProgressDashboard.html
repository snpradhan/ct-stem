{% extends "ctstem_app/base.html" %}
{% load ctstem_extras %}

{% block media %}
  {{ block.super }}
  {{ form.media }}
  <script src="https://code.highcharts.com/highcharts.js"></script>

{% endblock %}
{% block title %}Assignment ProgressDashboard |{% endblock %}

{% block content %}
  {{block.super}}
  <div class="content" id="assignment_progress_dashboard">
    <h5 class="left"><a href="{{ request.META.HTTP_REFERER }}"><i class="fas fa-arrow-left"></i> Back </a></h5>
    <div class="legends">
      <div>
        <a type="button" class="btn small green"> <i class="far fa-comment-dots"></i> </a>
        &nbsp;
        <label>Feedback Given</label>
      </div>
      <div>
        <a type="button" class="btn small yellow"> <i class="far fa-comment-dots"></i> </a>
        &nbsp;
        <label>Feedback Pending</label>
      </div>
      <div>
        <i class="fas fa-times fa-2x"></i>
        &nbsp;
        <label>Not yet started</label>
      </div>
      <div>
        <i class="far fa-window-minimize fa-2x"></i>
        &nbsp;
        <label>No Question</label>
      </div>
    </div>
    <form method="post" action="{% url 'ctstem:assignmentProgressDashboard' teacher_id %}" id="progress_search_form">
      {% csrf_token %}
      <div class="progress_filter">
        <div class="form-group">
          <label>{{filter_form.group.label|title}}</label>
          <div>{{filter_form.group}}</div>
        </div>
        <div class="form-group">
          <label>{{filter_form.assignment.label|title}}</label>
          <div>{{filter_form.assignment}}</div>
          <div class="warning">{{ filter_form.assignment.errors }}</div>
        </div>
        <div class="form-group">
          <label>{{filter_form.sort_by.label|title}}</label>
          <div>{{filter_form.sort_by}}</div>
        </div>
      </div>
    </form>
    <div class="dashboard_container">
      <table class="table table-striped table-bordered table-condensed" id="assignment_progress">

        <thead>
          <tr>
            <th class="student_col"></th>
            {% for step in header %}
              {% with questions=step|get_item:'questions' %}
                <th colspan={{questions|length}}>P{{step|get_item:'order'}}: {{step|get_item:'title'}}</th>
              {% endwith %}
            {% endfor %}
            <th colspan="3">
            </th>
          </tr>
          <tr>
            <th class="student_col">
            </th>
            {% for step in header %}
              {% with questions=step|get_item:'questions' %}
                {% if questions %}
                  {% for question in questions %}
                    <th>
                      Q: {{step.order}}.{{question.order}}
                      <br>
                      <a href="{% url 'ctstem:question_response_review' assignment.id question.id %}" title="Give Feedback"> <span class="far fa-comment-dots" aria-hidden="true"></span> </a>
                    </th>
                  {% endfor %}
                {% else %}
                  <th><i class="far fa-window-minimize"></i></th>
                {% endif %}
              {% endwith %}
            {% endfor %}
            <th>% Complete</th>
            <th>Time Spent</th>
            <th>Last Worked On</th>
          </tr>
        </thead>
        <tbody>
          {% for student_id, details in student_progress.items %}
          {% with student=details|get_item:'student' progress=details|get_item:'progress' percent_complete=details|get_item:'percent_complete' instance=details|get_item:'instance' %}
          <tr>
            <td class="student_col">
              {{student}}
              <a href="{% url 'ctstem:feedback' assignment.id instance.id %}" title="Give Feedback"> <span class="far fa-comment-dots" aria-hidden="true"></span> </a>
            </td>
            {% for question_progress in progress %}
              <td class="question">
                {% if question_progress == 1 %}
                  <i class="fas fa-times"></i>
                {% elif question_progress == 0 %}
                  <i class="far fa-window-minimize"></i>
                {% else %}
                  {% with response=question_progress|get_item:'response' feedback=question_progress|get_item:'feedback' %}
                    <a type="button" class="btn small add_feedback {% if feedback and feedback.feedback %} green {% else %} yellow {% endif %}" data-form="{% url 'ctstem:questionFeedback' response.id %}" title="Give Feedback"> <span class="far fa-comment-dots" aria-hidden="true"></span> </a>
                  {% endwith %}
                {% endif %}
              </td>
            {% endfor %}
            <td class="percent_complete">
              {{percent_complete}}%
            </td>
            <td class="time_spent">{{instance.time_spent|format_time}}</td>
            <td class="last_modified">{{instance.modified_date|date}}</td>
          </tr>
          {% endwith %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script type="text/javascript">

    $(function() {
      $(".chart").each(function(){
        render_donut_chart($(this));
      });

      $(".add_feedback").click(function(e){
        e.preventDefault();
        var url = $(this).data("form");
        $("#questionModal").load(url, function() {
          $(this).modal('show');
        });

        return false;
      });

      var timeout = null;
      $('#progress_search_form select, #progress_search_form :radio').on('change', function(){
        if($(this).attr('id') == 'id_group'){
          $('select#id_assignment').val('');
        }
        $('#progress_search_form').submit();
      });

    });
  </script>

{% endblock %}


