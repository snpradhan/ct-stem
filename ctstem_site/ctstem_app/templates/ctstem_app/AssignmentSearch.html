{% block media %}
  {{ form.media }}
{% endblock %}
<div class="modal-dialog modal-lg">
  <div class="modal-content">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal">&times;</button>
      <h3 class="modal-title">{{title}}</h3>
    </div>
    <div id="assignmentMsg">
    </div>
    <form class="form" id="assignmentForm" method="post" action="{% url 'ctstem:searchAssignment' %}">
      {% csrf_token %}

      <div class="modal-body">
        <div class="form-group">
          <label for="id_type">Assignment Type</label>
          <div>{{form.assignment_type}}</div>
        </div>
        <div class="form-group">
          <label for="id_title">Title</label>
          <div>{{form.title}}</div>
        </div>
        <div class="form-group">
          <label for="id_subject">Subject</label>
          <div>{{form.subject}}</div>
        </div>
        <div class="form-group">
          <label for="id_standards">Standards</label>
          <div>{{form.standards}}</div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="form-group button-row">
          <button type="submit" id="search" class="btn btn-success">
            Search
          </button>
        </div>
      </div>
    </form>
    <div id="assignmentResults" style="display:none;">
      <table class="table table-bordered table-striped table-condensed inner_table">
        <thead>
          <tr>
            <th>Title</th>
            <th>Subject</th>
            <th>Standards</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script type="text/javascript">
$(function (){

  $("#assignmentForm").submit(function(e) {

    e.preventDefault();
    $("#assignmentResults table tbody").empty();
    data = {}
    data['type'] = $("#id_assignment_type").val();
    data['standards'] = $("#id_standards").val();
    data['subject'] = $("#id_subject").val();
    data['title'] = $("#id_title").val();
    data['csrfmiddlewaretoken'] = $('#assignmentForm').find('input:hidden').eq(0).val();
    var data = $.param(data);
    /*var url = "{% url 'ctstem:newQuestion' %}";*/
    $.ajax({
      type: $(this).attr('method'),
      url: this.action,
      data: data,
      context: this,
      success: function(data){
        if('error' in data){
          $('#assignmentMsg').html(data['error']);
        }
        else {
          var assignment = "";
          $.each(data, function(key, value){
            assignment += "<tr><td>"+value['title']+"</td><<td>"+value['subject']+"</td><td>"+value['standards']+"</td><td><button type='button' class='btn btn-info select_assignment' id='"+value['id']+"''>Assign</a></td></tr>";
          });
          $("#assignmentResults table tbody").html(assignment);
          $("#assignmentResults").show();
          $("#assignmentResults button.select_assignment").click(function(){
            //if the taxonomy isn't already selected
            if($('select[id^="id"][id$="taxonomy"] option[value="'+$(this).attr('id')+'"]').prop('selected') == false){
              //select the taxonomy in the lesson plan taxonomy dropdown with is hidden
              $('select[id^="id"][id$="taxonomy"] option[value="'+$(this).attr('id')+'"]').prop('selected', true);
              //add the selected taxonomy to the lesson plan taxonomy table
              var taxonomy_row = $(this).closest('tr');
              taxonomy = "<tr id='"+$(this).attr('id')+"'>";
              $(taxonomy_row).find('td:not(:last)').each(function(){
                taxonomy += "<td>"+$(this).html()+"</td>";
              });
              taxonomy += "<td> <button type='button' class='btn btn-danger remove_taxonomy' title='Remove Taxonomy'><span class='glyphicon glyphicon-trash' aria-hidden='true'></span></button></td>";
              $('div.curriculum_content div#taxonomy_div table#taxonomy tbody').append(taxonomy);

              //bind remove function
              $("button.remove_taxonomy").click(function(e){
                var taxonomy_id = $(this).closest('tr').attr('id');
                $('select[id^="id"][id$="taxonomy"] option[value="'+taxonomy_id+'"]').prop('selected', false);
                $('div.curriculum_content div#taxonomy_div table#taxonomy tbody tr#'+taxonomy_id).remove();
              });
            }
          });
          //$("#taxonomyForm")[0].reset();
          //$("#taxonomyModal").modal('toggle');
        }
        return false;
      },
      error: function(xhr, ajaxOptions, thrownError){
        alert(thrownError);
      },
    });
  });

});

</script>
