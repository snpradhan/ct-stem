<div class="modal fade" id="studentSearch" role="dialog">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h3 class="modal-title">Search Students</h3>
      </div>
      <div id="studentMsg" class="msg">
      </div>
      <form class="form" id="studentForm" method="post" action="{% url 'ctstem:searchStudents' %}">
        {% csrf_token %}
        <input type="hidden" name="group_id" value="{{form.instance.id}}"/>
        <div class="modal-body">
          <div class="form-inline">
            <div class="form-group">
              <label for="id_username">Username</label>
              <div>{{studentSearchForm.username}}</div>
            </div>
            <div class="form-group">
              <label for="id_first_name">First Name</label>
              <div>{{studentSearchForm.first_name}}</div>
            </div>
            <div class="form-group">
              <label for="id_last_name">Last Name</label>
              <div>{{studentSearchForm.last_name}}</div>
            </div>
            <div class="form-group">
              <label for="id_email">Email</label>
              <div>{{studentSearchForm.email}}</div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <div class="form-group button-row">
            <button type="submit" id="search" class="btn btn-success">
              Search
            </button>
          </div>
        </div>
      </form>
      <div id="studentResults" style="display:none;" class="results">
        <table class="table table-bordered table-striped table-condensed inner_table">
          <thead>
            <tr>
              <th>Username</th>
              <th>Name</th>
              <th>Email</th>
              <th>Status</th>
              <th>Last Login </th>
              <th>Select?</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
$(function (){

  $("#id_standard").change(function(){
    var html = "<option value 'selected'>----------</option>";
    if($(this).val() != ''){
      var url = "{% url 'ctstem:categories' 0 %}".replace('0', $(this).val());
      $.ajax({
        type: 'GET',
        url: url,
        context: this,
        success: function(data){
          data['category_list'].forEach(function(element, index, array){
            html += "<option value='"+element['id']+"'>"+element['category']+"</option>";
          });
          $('select#id_category').html(html);
        },
        error: function(xhr, ajaxOptions, thrownError){
          alert(thrownError);
        },
      });
    }
    else{
      $('select#id_category').html(html);
    }
  });

  $("#studentForm").submit(function(e) {

    e.preventDefault();
    $("#studentResults table tbody").empty();


    /*var url = "{% url 'ctstem:newQuestion' %}";*/
    $.ajax({
      type: $(this).attr('method'),
      url: this.action,
      data: $(this).serialize(),
      context: this,
      success: function(data){
        if('error' in data){
          $('#studentMsg').html(data['error']);
        }
        else {
          var student_row = "";
          $.each(data, function(key, value){
            //if the student isn't already added

            if($('tr#'+value['student_id']).length == 0){
              student_row = "<tr><td>"+value['username']+"</td><td>"+value['name']+"</td><<td>"+value['email']+"</td><td>"+value['status']+"</td><td>"+value['last_login']+"</td><td><button type='button' class='btn btn-info select_student' id='"+value['student_id']+"''>Add</a></td></tr>";

              $("#studentResults table tbody").append(student_row);
              $("#studentResults button.select_student#"+value["student_id"]).click(function(){

                //add student detail to the table
                $('table.table#members tbody').append('<tr id='+value['student_id']+'>\
                  <td>'+value['username']+'\
                    <div class="controls">\
                      <a type="button" class="btn btn-success edit" aria-label="Edit User" title="Edit User" href="/user/'+value['user_id']+'">\
                        <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>\
                      </a>\
                      <a type="button" class="btn btn-warning removeUser" aria-label="Remove Student" title="Remove Student" href="/student/remove/'+value['group']+'/'+value['student_id']+'" data-id="'+value['student_id']+'">\
                        <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>\
                      </a>\
                    </div>\
                  </td>\
                  <td>'+value['name']+'</td>\
                  <td>'+value['email']+'</td>\
                  <td>'+value['status']+'</td>\
                  <td>'+value['last_login']+'</td></tr>');

                //add student membership hidden input
                $('table.table#members').before('<input id="id_group-members_'+value['student_id']+'" name="group-members" type="hidden" value="'+value['student_id']+'">');
                // ajax add student to group
                var data = {};
                data['csrfmiddlewaretoken'] = $('#studentForm').find('input:hidden').eq(0).val();
                $.ajax({
                  type: 'POST',
                  url: '/student/add/'+value['group']+'/'+value['student_id'],
                  data: data,
                  context: this,
                  success: function(data){
                    if('error' in data){
                      $('#studentMsg').html(data['error']);
                    }
                    else {
                      bind_user_removal();
                    }
                    return false;
                  },
                });
                $(this).attr('disabled', 'disabled');
              });
            }
          });
          if(student_row.length == 0){
            $('#studentMsg').html('No matching students found');
            $("#studentResults").hide();
          }
          else{
            $('#studentMsg').html('');
            $("#studentResults").show();

          }
          //$("#studentForm")[0].reset();
          //$("#studentModal").modal('toggle');
        }
        return false;
      },
      error: function(xhr, ajaxOptions, thrownError){
        alert(thrownError);
      },
    });
  });

});

</script>
