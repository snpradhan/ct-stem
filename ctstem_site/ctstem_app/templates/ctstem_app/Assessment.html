{% extends "ctstem_app/base.html" %}
{% load ctstem_extras %}
{% block title %}Assessment |{% endblock %}
{% block media %}
  {{block.super}}
  {% load wysiwyg %}
  {% wysiwyg_setup %}
  {% include "ctstem_app/django_wysiwyg_includes.html" %}
{% endblock %}

{% block content %}
  {{block.super}}
  <div class="content">
    <h2>Assessment</h2>
    <form method="post">
      {% csrf_token %}
      <div class="table" id="assessment">
        {{form.management_form}}
        {% for field in form %}
          <div class="form-group">
            <label for="id_{{field.name}}">{{ field.label }} {% if field.field.required %} (<span class="required">*</span>) {% endif %}</label>
            <div>{{field}}</div>
            <div class="error">{{ field.errors }}</div>
          </div>
        {% endfor %}
      </div>
      {{formset.management_form}}
      {% for step in formset %}
        <div class="table step">
          {{ step.management_form }}
          {{step.id}}

          <div class="form-group">
            <label for="id_{{step.title.name}}">{{ step.title.label }} {% if step.title.field.required %}(<span class="required">*</span>) {% endif %}</label>
            <div>{{step.title}}</div>
            <div class="error">{{ step.title.errors }}</div>
          </div>
          <div class="form-group">
            <label for="id_{{step.content.name}}">{{ step.content.label }} {% if step.content.field.required %}(<span class="required">*</span>) {% endif %}</label>
            <div>
              {{step.content}}
              {% wysiwyg_editor step.content.auto_id %}
            </div>
            <div class="error">{{ step.content.errors }}</div>
          </div>
          <div class="form-group">
            <label for="id_{{step.teacher_notes.name}}">{{ step.teacher_notes.label|title }} {% if step.teacher_notes.field.required %}(<span class="required">*</span>) {% endif %}</label>
            <div>
              {{step.teacher_notes}}
              {% wysiwyg_editor step.teacher_notes.auto_id %}
            </div>
            <div class="error">{{ step.teacher_notes.errors }}</div>
          </div>
          <div class="form-group question_table">
            {{step.nested.management_form}}
            {{step.nested.id}}
            <label for="id_question_table">Step Question(s)</label>
            <button class="btn btn-primary edit_question" name="add_question" data-form="{% url 'ctstem:newQuestion' %}">
              <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
            </button>
            <table class="table table-striped table-condensed lessonQuestion">
              <thead>
                <tr>
                  <th></th>
                  <th style="width:60%;"></th>
                  <th></th>
                  <th>Order</th>
                  <th>Delete</th>
                </tr>
              </thead>
              <tbody>
                {% for questionForm in step.nested %}
                  <tr style="{% if forloop.last %} display:none; {% endif %}" id="question_row_{{questionForm.question.value}}">
                    <td class="question_order">
                      {{questionForm.id}}
                      <div>
                        Q{{questionForm.ORDER.value}}.
                      </div>
                    </td>
                    <td class="question_text">
                      {% if questionForm.question.value and questionForm.question.value != 'None' %}
                        <input type="hidden" class="question_id" id="{{questionForm.question.auto_id}}" name="{{questionForm.question.html_name}}" value="{{questionForm.question.value}}"/>
                        <div> {{questionForm.question.value|selected_question|safe }} </div>

                      {% else %}
                        <input type="hidden" class="question_id" id="{{questionForm.question.auto_id}}" name="{{questionForm.question.html_name}}" value/>
                      {% endif %}
                    </td>
                    <td>
                      <button type="button" class="btn btn-success edit_question" name="edit_question" aria-label="Edit Question" data-form="{% url 'ctstem:question' questionForm.question.value|default:0 %}" >
                        <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
                      </button>
                    </td>
                    <td>{{questionForm.ORDER }}</td>
                    <td>{{questionForm.DELETE }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="form-group">
            <label for="id_{{step.ORDER.name}}">{{ step.ORDER.label }}</label>
            <div>{{step.ORDER}}</div>
            <div class="error">{{ step.ORDER.errors }}</div>
          </div>
          <div class="form-group">
            <label for="id_{{step.DELETE.name}}">{{ step.DELETE.label }}</label>
            <div>{{step.DELETE}}</div>
            <div class="error">{{ step.DELETE.errors }}</div>
          </div>
        </div>
      {% endfor %}
      <div class="form-group button-group-fixed">
        <input type="submit" class="btn btn-success" id="submit" value="Save"/>
        <input type="button" class="btn btn-primary" id="addStep" value="Add Step"/>
      </div>
      <div class="modal fade" id="questionModal" role="dialog">
      </div>
    </form>
  </div>
  <script type="text/javascript">
    $(function (){
      $("button.edit_question").click(function(e){
        e.preventDefault();
        var url = $(this).data("form");
        var step_div = $(this).closest('.step');
        var step_id = $(step_div).children(':hidden').first().attr('id');
        $("#questionModal").load(url, function() {
          $(this).modal('show');
          $("#questionModal input[id='id_step']").val(step_id);
        });

        return false;
      });

      $('#addStep').click(function() {
        cloneMore('div.table:last', 'form');
        //alert('after clone');
        bindWysiwyg();
        //rebind question clone
      });

      function bindWysiwyg(){
        //alert($(step).attr('class'));
        $('div.table:last').find('textarea').each(function(){
          var id = $(this).attr('id');
          var editor = $(this).attr('id')+'_editor';
          var config = null;
          django_wysiwyg.enable(editor, id, config);
          $(this).next().show();
        });
      }
    });
  </script>

{% endblock %}
