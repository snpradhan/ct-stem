{% extends "ctstem_app/base.html" %}
{% load ctstem_extras %}

{% block title %}Lesson |{% endblock %}
{% block media %}
  {{block.super}}
  {% load wysiwyg %}

  {% wysiwyg_setup %}
  {% include "ctstem_app/django_wysiwyg_includes.html" %}
{% endblock %}

{% block content %}
  {{block.super}}
  <div class="content">
    <h2>Lesson</h2>
    <form method="post">
      {% csrf_token %}
      <div class="table" id="lesson">
        {{form.management_form}}
        {% for field in form %}
          <div class="form-group">
            <label for="id_{{field.name}}">{{ field.label }}</label>
            {% if field.name == 'questions' %}
              <div class="clearfix">
                {{field}}
              </div>
            {% elif field.name == 'content' %}
              <div>
                {{field}}
                {% wysiwyg_editor "id_lesson-content" %}
              </div>
            {% elif field.name == 'teacher_notes' %}
              <div>
                {{field}}
                {% wysiwyg_editor "id_lesson-teacher_notes" %}
              </div>
            {% else %}
              <div>
                {{field}}
              </div>
            {% endif %}
            <div class="error">{{ field.errors }}</div>
          </div>
        {% endfor %}
      </div>

      <div class="table" id="lessonQuestions">
        <h3>Activity Questions</h3>
        {{formset.management_form}}
        <table class="table">
          <thead>
            <tr>
              <th></th>
              <th>Question</th>
              <th>Order</th>
              <th>Delete</th>
            </tr>
          </thead>
          <tbody>
            {% for questionForm in formset %}
              <tr>
                <td>
                  {{form.id}}
                  {{questionForm.id}}
                  Q{{forloop.counter}}.
                </td>
                <td>
                  {% if questionForm.question.value and questionForm.question.value != 'None' %}
                    <input type="hidden" id="{{questionForm.question.auto_id}}" name="{{questionForm.question.html_name}}" value="{{questionForm.question.value}}"/>
                    {{questionForm.question.value|selected_question }}
                  {% else %}
                    <input type="hidden" id="{{questionForm.question.auto_id}}" name="{{questionForm.question.html_name}}" value/>
                  {% endif %}
                </td>
                <td>{{questionForm.ORDER }}</td>
                <td>{{questionForm.DELETE }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="form-group button-group-fixed">
          <input type="submit" class="btn btn-success" id="submit" value="Save Lesson"/>
          <a href="#" class="btn btn-primary" data-toggle="modal" data-target="#questionForm">Add Question</a>
        </div>
    </form>
    {% block questionform %}
      <div class="modal fade" id="questionForm" role="dialog">
        <div class="modal-dialog modal-md">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal">&times;</button>
              <h3 class="modal-title">Add Question</h3>
            </div>
            <form class="form" id="formAddQuestion" method="post">
              {% csrf_token %}
              <div class="modal-body">
                {% for field in newQuestionForm %}
                  <div class="form-group">
                    <label for="id_{{field.name}}">{{ field.label|title }}</label>
                    <div>
                      {{field}}
                      {% if field.name == 'question_text' %}
                        {% wysiwyg_editor field.auto_id %}
                        <input type="hidden" id="question_html" name="question_html" />
                      {% endif %}
                    </div>
                    <div class="error">{{ field.errors }}</div>
                  </div>
                {% endfor %}
              </div>
              <div class="modal-footer">
                <div class="form-group button-row">
                  <button type="submit" id="addQuestion" class="btn btn-success">
                    <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                    Add
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% endblock %}
  </div>
  <script type="text/javascript">
    $(function (){
      $("#questionForm").submit(function(e) {
        e.preventDefault();
        var question_text = tinymce.get('id_question_text').getContent();
        data = {}
        data['question_text'] = question_text;
        data['answer_field_type'] = $("#id_answer_field_type").val();
        data['options'] = $("#id_options").val();
        data['answer'] = $("#id_answer").val();
        data['csrfmiddlewaretoken'] = $('#formAddQuestion').find('input:hidden').eq(0).val();

        var data = $.param(data);
        var url = "{% url 'ctstem:add_question' %}";
        $.ajax({
          type: "POST",
          url: url,
          data: data,
          dataType: 'json',
          success: function(data){
            cloneMore('table.table tr:last', 'question');

          },
          error: function(xhr, ajaxOptions, thrownError){

          },
        });
      });
    });
  </script>
{% endblock %}
