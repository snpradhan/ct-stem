{% extends "ctstem_app/base.html" %}
{% load ctstem_extras %}

{% block title %}Lesson |{% endblock %}

{% block content %}
  {{block.super}}
  <div class="content">
    <h2> Lesson Plan </h2>
    <form method="post">
      {% csrf_token %}
      {{form.media}}
      <div class="table" id="lesson">
        <h4>
          <span>&nbsp;</span>
          <span class="lesson_title" style="font-weight: bold; text-decoration: underline;">{{form.title.value|default_if_none:"  "}}</span>
          <span>&nbsp;</span>
          <span class="controls">
            <span class="expand_collapse">
              <button type="button" class="btn btn-warning" name="collapse_lesson" aria-label="Collapse Lesson" title="Collapse Lesson">
                <span class="glyphicon glyphicon-collapse-up" aria-hidden="true"></span>
              </button>
              <button type="button" class="btn btn-success" style="display:none;" name="expand_lesson" aria-label="Expand Lesson" title="Expand Lesson">
                <span class="glyphicon glyphicon-collapse-down" aria-hidden="true"></span>
              </button>
            </span>
          </span>
        </h4>
        <div class="curriculum_content collapsible_content">
          {{form.management_form}}
          {% for field in form %}
            <div class="form-group">
              <label for="id_{{field.name}}">{{ field.label }} {% if field.field.required %}(<span class="required">*</span>) {% endif %}</label>
              {% if field.name == 'questions' %}
                <div class="clearfix">
                  {{field}}
                </div>
              {% elif field.name == 'taxonomy' %}
                <button class="btn btn-primary search_taxonomy" name="search_taxonomy" data-form="{% url 'ctstem:searchTaxonomy' %}">
                  <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
                </button>
                <div style="display:none;">
                  {{field}}
                </div>
                <div id="taxonomy_div">
                  <table class="table table-bordered table-striped table-condensed inner_table" id="taxonomy">
                    <thead>
                      <tr>
                        <th>Standard</th>
                        <th>Category</th>
                        <th>Title</th>
                        <th>Code</th>
                        <th>Remove?</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for x in field.value %}
                        {% with taxonomy=x|getTaxonomy %}
                        <tr id="{{taxonomy.id}}">
                          <td>{{taxonomy.category.standard.short_name}}</td>
                          <td>{{taxonomy.category.name}}</td>
                          <td>{{taxonomy.title}}</td>
                          <td>{{taxonomy.code}}</td>
                          <td>
                            <button type="button" class="btn btn-danger remove_taxonomy" title="Remove Taxonomy">
                              <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                            </button>
                          </td>
                        </tr>
                        {% endwith %}
                      {% endfor %}
                    </tbody>
                  </table>
                </div>

              {% else %}
                <div>
                  {{field}}
                </div>
              {% endif %}
              <div class="error">{{ field.errors }}</div>
            </div>
          {% endfor %}
        </div>
      </div>

      {{formset.management_form}}
      {% for activity in formset %}
        <div class="table activity" style="{% if forloop.last %} display:none; {% endif %}">
          <h4>
            <span>&nbsp;</span>
            <span class="activity_title" style="font-weight: bold; text-decoration: underline;">{{activity.title.value|default_if_none:"  "}}</span>
            <span>{% if activity.ORDER.value %}({{activity.ORDER.value}}) {% endif %}</span>
            <span>&nbsp;</span>
            <span class="controls">
              <span>
                <button type="button" class="btn btn-danger delete_activity" name="delete_activity" aria-label="Delete Activity" title="Delete Activity">
                  <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                </button>
                {{activity.DELETE.as_hidden}}
              </span>
              <span class="expand_collapse">
                <button type="button" class="btn btn-warning" name="collapse_activity" aria-label="Collapse Activity" title="Collapse Activity">
                  <span class="glyphicon glyphicon-collapse-up" aria-hidden="true"></span>
                </button>
                <button type="button" class="btn btn-success" style="display:none;" name="expand_activity" aria-label="Expand Activity" title="Expand Activity">
                  <span class="glyphicon glyphicon-collapse-down" aria-hidden="true"></span>
                </button>
              </span>
            </span>
          </h4>

          {{ activity.management_form }}
          {{activity.id}}
          <div class="curriculum_content collapsible_content">
            <div class="form-group order">
              <label for="id_{{activity.ORDER.name}}"> Activity #.</label>
              <div>{{activity.ORDER}}</div>
              <div class="error">{{ activity.ORDER.errors }}</div>
            </div>
            <div class="form-group">
              <label for="id_{{activity.title.name}}">{{ activity.title.label }} {% if activity.title.field.required %}(<span class="required">*</span>) {% endif %}</label>
              <div class="activity_title">{{activity.title}}</div>
              <div class="error">{{ activity.title.errors }}</div>
            </div>
            <div class="form-group">
              <label for="id_{{activity.content.name}}">{{ activity.content.label }} {% if activity.content.field.required %}(<span class="required">*</span>) {% endif %}</label>
              <div>
                {{activity.content}}
              </div>
              <div class="error">{{ activity.content.errors }}</div>
            </div>

            <div class="form-group question_table">
              {{activity.nested.management_form}}
              {{activity.nested.id}}
              <label for="id_question_table">Activity Question(s)</label>
              <button class="btn btn-primary edit_question" name="add_question" data-form="{% url 'ctstem:newQuestion' %}" aria-label="Add New Question" title="Add New Question">
                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
              </button>
              <table class="table table-striped table-condensed table-bordered question inner_table">
                <thead>
                  <tr>
                    <th>Q#.</th>
                    <th style="width:70%;">Question</th>
                    <th>Delete/Edit</th>
                  </tr>
                </thead>
                <tbody>
                  {% for questionForm in activity.nested %}
                    <tr style="{% if forloop.last %} display:none; {% endif %}" id="question_row_{{questionForm.question.value}}">
                      <td class="order">
                        {{questionForm.id}}
                        {{questionForm.ORDER}}
                      </td>
                      <td class="question_text">
                        {% if questionForm.question.value and questionForm.question.value != 'None' %}
                          {{questionForm.question.as_hidden}}
                          <div> {{questionForm.question.value|selected_question|safe }} </div>
                        {% else %}
                          {{questionForm.question.as_hidden}}
                          <div></div>
                        {% endif %}
                      </td>
                      <td class="question_edit">
                        <button type="button" class="btn btn-danger delete_question" name="delete_question" aria-label="Delete Question" title="Delete Question">
                          <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                        </button>
                        {{questionForm.DELETE.as_hidden}}
                        <button type="button" class="btn btn-success edit_question" name="edit_question" aria-label="Edit Question" title="Edit Question" data-form="{% url 'ctstem:question' questionForm.question.value|default:0 %}" >
                          <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
                        </button>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      {% endfor %}

      <div class="form-group button-group-fixed">
        <input type="submit" class="btn btn-success" id="submit" value="Save"/>
        <input type="button" class="btn btn-primary" id="addActivity" value="Add Activity"/>
      </div>
    </form>
    <div class="modal fade" id="questionModal" role="dialog"></div>
    <div class="modal fade" id="taxonomyModal" role="dialog"></div>
  </div>
  <script type="text/javascript">
    $(function (){
      $("button.edit_question").click(function(e){
        e.preventDefault();
        var url = $(this).data("form");
        var activity_div = $(this).closest('.activity');
        var activity_id = $(activity_div).children(':hidden').first().attr('id');
        $("#questionModal").load(url, function() {
          $(this).modal('show');
          $("#questionModal input[id='id_activity']").val(activity_id);
        });

        return false;
      });

      $("button.search_taxonomy").click(function(e){
        e.preventDefault();
        var url = $(this).data("form");
        $("#taxonomyModal").load(url, function() {
          $(this).modal('show');
        });
        return false;
      });

      $("button.remove_taxonomy").click(function(e){
        var taxonomy_id = $(this).closest('tr').attr('id');
        $('#id_lesson-taxonomy option[value="'+taxonomy_id+'"]').prop('selected', false);
        $('div.curriculum_content div#taxonomy_div table#taxonomy tbody tr#'+taxonomy_id).remove();
      });

      $('#addActivity').click(function() {
        cloneMore('div.table:last', 'form');
        var new_activity_div = $('div.table:last').prev();
        $(new_activity_div).toggle();

        $(new_activity_div).find('textarea').each(function(){
          if($(this).attr('name') !== undefined && $(this).attr('data-config') !== undefined){
            var config = {
              removePlugins: 'stylesheetparser',
              toolbar: 'None',
              height: 300,
              width: 950,
              allowedContent: true,
              filebrowserUploadUrl: "/ckeditor/upload/",
              filebrowserBrowseUrl: "/ckeditor/browse/",
              skin: "moono",
              mathJaxLib: '//cdn.mathjax.org/mathjax/2.2-latest/MathJax.js?config=TeX-AMS_HTML',
              extraPlugins: 'mathjax',
            }
            CKEDITOR.replace($(this).attr('name'), config);
          }
        });

        /*var activity_order_div = $('div.table:last span.activity_order');
        var activity_order = parseInt($(activity_order_div).html()) + 1;
        $(activity_order_div).html(activity_order);*/
      });

      $('input#id_lesson-title').on('input', function(){
        $(this).closest('div.table').find('h4 span.lesson_title').html($(this).val());
      });
      $('div.activity_title input').on('input', function(){
        $(this).closest('div.table.activity').find('h4 span.activity_title').html($(this).val());
      });

      $('button.delete_activity').click(function(){
        var r = confirm("Are you sure you want to delete this activity?");
        if (r == true) {
          $(this).next('input').val('on');
          $(this).closest('div.table.activity').hide();
        }
      });
      $('button.delete_question').click(function(){
        var r = confirm("Are you sure you want to delete this question?");
        if (r == true) {
          $(this).next('input').val('on');
          $(this).closest('tr').hide();
        }
      });

    });
  </script>

{% endblock %}
