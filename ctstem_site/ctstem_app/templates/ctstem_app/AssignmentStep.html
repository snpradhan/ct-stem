{% extends "ctstem_app/base.html" %}
{% load ctstem_extras %}

{% block title %} {{curriculum.title}} {%endblock %}

{% block bootstrap_css %}{% endblock %}
{% block datatable %}{% endblock %}
{% block django_admin %}{% endblock %}
{% block misc %}{% endblock %}
{% block agency %}{% endblock %}
{% block ctstem %}
  <script type="text/javascript" src="/static/js/session.js"></script>
{% endblock %}

{% block custom_media %}
  <link href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Maitree:400,700|Roboto+Condensed:300,400,700italic" rel="stylesheet">
  <!--script src="http://ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script-->
  <script src="http://canvasjs.com//assets/script/canvasjs.min.js"></script>
  <link rel="stylesheet" href="/static/css/bootstrap-modal.css">
  <link rel="stylesheet" href="/static/css/table.css">
  <link rel="stylesheet" href="/static/css/messages.css">
  <link rel="stylesheet" href="/static/css/assignment.css">
  <script type="text/javascript" src="/static/js/jquery.form.min.js"></script>
  <link rel="stylesheet" href="/static/css/sketch.css">
  <script type="text/javascript" src="/static/js/sketch.js"></script>
  <script type="text/javascript" src="/static/js/sketch_custom.js"></script>
  <script type="text/javascript" src="/static/js/clone_more.js"></script>
  <script type="text/javascript" src="/static/js/assignment.js"></script>
{% endblock %}

{% block header %}{% endblock %}

{% block content %}
  <header>
    <div class="header-box">
      <h1>CT-STEM</h1>
      {{curriculum.title|title}}
      <nav>
        Page &nbsp;
        {% if step_order|add:0  == 0 %}
          <a class="page-link selected">{{1}}</a>
        {% else %}
          <a class="page-link linked" href="{% url 'ctstem:resumeAssignment'  instance.assignment.id instance.id 0 %}">{{1}}</a>
        {% endif %}
        {% for i in total_steps|iterate %}
          {% if instance.status == 'S' or instance.status == 'F' or instance.status == 'A' %}
            {% if i|add:0 == step_order|add:0 %}
              <a class="page-link selected linked" href="{% url 'ctstem:resumeAssignment'  instance.assignment.id instance.id i %}">{{i|add:1}}</a>
            {% else %}
              <a class="page-link linked" href="{% url 'ctstem:resumeAssignment'  instance.assignment.id instance.id i %}">{{i|add:1}}</a>
            {% endif %}
          {% else %}
            {% if i|add:0 < step_order|add:0 %}
              <a class="page-link linked" href="javascript:waitForSave('{% url 'ctstem:resumeAssignment'  instance.assignment.id instance.id i %}')" onclick="return saveStep('{{form.instance.instance.status}}');">{{i|add:1}}</a>
            {% elif i|add:0 == step_order|add:0 %}
              <a class="page-link selected">{{i|add:1}}</a>
            {% else %}
              <a class="page-link">{{i|add:1}}</a>
            {% endif %}
          {% endif %}
        {% endfor %}
      </nav>
    </div>
  </header>
  {{block.super}}
  <main>
    <div class="page">
      {% if step_order|add:0 == 0 %}
        <h2>Computational Thinking in Science and Math</h2>
        <h1>{{curriculum.title}}</h1>
        <hr>
        <p class="item">
          {% if curriculum.curriculum_type == 'S' %}
            Thanks for taking this survey about computational thinking!
            There are no right or wrong answers to these questions, we just want to know what you think.
          {% elif curriculum.curriculum_type == 'A' %}
            Thank you for taking this assessment!
            Please do the best that you can, and don't worry if you don't know all of the answers.
          {% elif curriculum.curriculum_type == 'L' %}
            {{curriculum.overview|safe}}
          {% endif %}
          {% if attachments %}
            <div>You will need additional resources to complete this assignment.  Please download them from this link <a href="{% url 'ctstem:downloadAttachments' curriculum.id%}" target="_blank">Download Attachment(s) <span class="fa fa-paperclip"></span></a></div>
          {% endif %}
        </p>
        <div class="save-buttons" style="text-align: center; margin-bottom: 150px; margin-top: 80px;">
          <a href="{% url 'ctstem:resumeAssignment'  instance.assignment.id instance.id 1 %}">
            <button class="continue">
              {% if instance.status == 'N' %}
                Start!
              {% else %}
                Continue
              {% endif %}
            </button>
          </a>
        </div>
      {% else %}
        <h2>{{form.instance.step.title}}</h2>
        <hr>
        <form method="post" enctype="multipart/form-data" id="assignmentForm">
          {% csrf_token %}
          {{form.management_form}}
          <input type="hidden" name="step_order" value="{{step.order}}"/>
          {% if instanceform %}
            <div class="teammates">
              {{instanceform.management_form}}
              <label>If you worked in a team, select your teammates from the list below:</label>
              {{instanceform.teammates}}
              <div class="warning">{{instanceform.teammates.help_text}}</div>
            </div>
          {% endif %}
          <div class="step_context">
            {% if form.instance.step.content %}
              {{form.instance.step.content|safe}}
              <hr>
            {% endif %}
          </div>
          <div class="question_container">
            {{formset.management_form}}
            <div class="question_table">
              {% for questionForm in formset %}
                {% with questionObj=questionForm.curriculum_question.value|get_curriculum_question %}
                {% with field_type=questionObj.answer_field_type %}
                {% if field_type != 'MH' %}
                  <div class="question_response_feedback {% if forloop.counter|divisibleby:2 %} even {% else %} odd {% endif %}">

                    <div class="question">
                      <label>Question:</label>
                      <div class="text">
                        {{questionForm.id}}
                        {{questionObj.question_text|inline_style|safe}}
                        {{questionForm.curriculum_question.as_hidden}}
                        {{questionForm.save.as_hidden}}
                        {{questionForm.nested.management_form}}
                        {{questionForm.nested.id}}
                      </div>
                    </div>

                    <div class="response">
                      <!-- completed assignment -->
                      {% if instance.status == 'F' or instance.status == 'S' or instance.status == 'A' %}
                        <label>Response:</label>
                        <div class="readonly text">
                          {% if field_type == 'FI' %}
                            <div class="file">
                            Uploaded file(s):
                            {% for fileform in questionForm.nested %}
                              {% if fileform.file.value %}
                                <div>
                                  <a href="{{fileform.file.value.url}}" target="_blank"><span class="glyphicon glyphicon-file" aria-hidden="true">{{fileform.file.value}}</span>
                                  </a>
                                </div>
                              {% endif %}
                            {% endfor %}
                            </div>
                          {% elif field_type == 'MI' %}
                            <img src="{{questionForm.response.value}}" class="image_option"/><br>
                          {% elif field_type == 'SK' %}
                            <canvas id="{{questionForm.response.auto_id}}_sketch" width="800" height="500" class="assignment_sketch" style="{% if questionObj.sketch_background %} background: url({{questionObj.sketch_background.url}}) no-repeat;{% endif %}"></canvas>
                            <input type="hidden" name="{{questionForm.response.html_name}}" id="{{questionForm.response.auto_id}}" value='{{questionForm.response.value}}'/>
                          {% elif field_type == 'DT' %}
                            <div class="assignment_input dt_input" id="dt_input_{{forloop.counter}}">
                              <input type="hidden" name="{{questionForm.response.html_name}}" id="{{questionForm.response.auto_id}}" value='{{questionForm.response.value}}'/>
                              <input type="hidden" name="column_headers" id="dt_col_headers_{{forloop.counter}}" value="{{questionObj.options}}"/>
                              <table class="table table-condensed table-bordered inner_table" id="dt_table_{{forloop.counter}}">
                                <thead>
                                </thead>
                                <tbody>
                                </tbody>
                              </table>
                            </div>
                          {% else %}
                            <div>
                              {{questionForm.response.value}}
                            </div>
                          {% endif %}
                        </div>
                      <!-- New and In Progress assignment -->
                      {% else %}
                        {% if field_type == 'TA' %}
                          <textarea placeholder="Enter your response" class="form-control assignment_textarea assignment_input" name="{{questionForm.response.html_name}}" id="{{questionForm.response.auto_id}}" >{{questionForm.response.value}}</textarea>
                        {% elif field_type == 'TF' %}
                          <input type="text" placeholder="Enter your response" class="form-control assignment_input" name="{{questionForm.response.html_name}}" id="{{questionForm.response.auto_id}}" value="{{questionForm.response.value}}" />
                        {% elif field_type == 'DD' %}
                          <select class="form-control assignment_input" name="{{questionForm.response.html_name}}" id="{{questionForm.response.auto_id}}">
                            {% for option in questionObj.options|splitlines%}
                              {% if option == questionForm.response.value %}
                                <option value="{{option}}" selected>{{option}}</option>
                              {% else %}
                                <option value="{{option}}">{{option}}</option>
                              {% endif %}
                            {% endfor %}
                          </select>
                        {% elif field_type == 'MC' %}
                          <div class="assignment_input" tabindex="-1">
                            {% for option in questionObj.options|splitlines%}
                              {% if option|slugify == questionForm.response.value|slugify %}
                                <input type="radio" name="{{questionForm.response.html_name}}" id="{{questionForm.response.auto_id}}" value="{{option}}"  checked="true"/>  {{option}}<br>
                              {% else %}
                                <input type="radio" name="{{questionForm.response.html_name}}" id="{{questionForm.response.auto_id}}" value="{{option}}" />  {{option}}<br>
                              {% endif %}
                            {% endfor %}
                          </div>
                        {% elif field_type == 'MI' %}
                          <div class="assignment_input" tabindex="-1">
                            {% for option in questionObj.options|splitlines%}
                              {% if option|slugify == questionForm.response.value|slugify %}
                                <input type="radio" name="{{questionForm.response.html_name}}" id="{{questionForm.response.auto_id}}" value="{{option}}" checked="true" />
                              {% else %}
                                <input type="radio" name="{{questionForm.response.html_name}}" id="{{questionForm.response.auto_id}}" value="{{option}}"/>
                              {% endif %}
                              <span>{{forloop.counter0|get_ascii_char}}.</span>
                              <img src="{{option}}" class="image_option"/><br><br>
                            {% endfor %}
                          </div>
                        {% elif field_type == 'MS' %}
                          <div class="assignment_input" tabindex="-1">
                            <input type="hidden" name="{{questionForm.response.html_name}}" id="{{questionForm.response.auto_id}}" value="{{questionForm.response.value}}"/>
                            {% with chosen=questionForm.response.value|split:',' %}
                            {% for option in questionObj.options|splitlines%}
                              {% if option|is_in:chosen %}
                                <input type="checkbox" name="{{questionForm.response.html_name}}_cb" id="{{questionForm.response.auto_id}}_cb" value="{{option}}" checked/>  {{option}}<br>
                              {% else %}
                                <input type="checkbox" name="{{questionForm.response.html_name}}_cb" id="{{questionForm.response.auto_id}}_cb" value="{{option}}"/>  {{option}}<br>
                              {% endif %}
                            {% endfor %}
                            {% endwith %}
                          </div>
                        {% elif field_type == 'FI' %}
                          <div  tabindex="-1">
                            <table class="table table-striped table-condensed table-bordered inner_table collapsible_content">
                              <thead>
                                <tr>
                                  <th>File</th>
                                  <th>Delete</th>
                                </tr>
                              </thead>
                              <tbody>
                                {% for fileform in questionForm.nested %}
                                  <tr style="{% if forloop.last %} display:none; {% endif %}">
                                    <td class="attached_file">
                                      {{fileform.id}}
                                      {% if fileform.instance.file %}
                                        <a href="{{fileform.instance.file.url}}">{{fileform.file.value}}</a>
                                        {{fileform.file.as_hidden}}
                                      {% else %}
                                        {{fileform.file}}
                                      {% endif %}
                                        <div class="error">
                                          {{fileform.file.errors}}
                                        </div>
                                    </td>

                                    <td class="attachment_edit">
                                      <button type="button" class="delete_attachment" name="delete_attachment" aria-label="Delete Attachment" title="Delete Attachment">
                                        <i class="fa fa-trash" aria-hidden="true"></i>
                                      </button>
                                      {{fileform.DELETE.as_hidden}}
                                    </td>
                                  </tr>
                                {% endfor %}
                              </tbody>
                            </table>
                            <button type="button" class="add_attachment" id="form-{{forloop.counter0}}-response_file" title="Add New Attachment">
                                Upload more
                            </button>
                          </div>
                        {% elif field_type == 'SK' %}
                          <div class="assignment_input" tabindex="-1">
                            <div class="note"> Note: Draw your sketch in the sketchpad below </div>
                            <div id="{{questionForm.response.auto_id}}_sketch_tools" class="sketch_tools"></div>
                            <canvas id="{{questionForm.response.auto_id}}_sketch" width="800" height="500" class="assignment_sketch" style="{% if questionObj.sketch_background %} background: url({{questionObj.sketch_background.url}}) no-repeat;{% endif %}"></canvas>
                            <input type="hidden" name="{{questionForm.response.html_name}}" id="{{questionForm.response.auto_id}}" value='{{questionForm.response.value}}'/>
                          </div>
                         <br>
                        <!-- Data table -->
                        {% elif field_type == 'DT' %}
                          <div class="assignment_input dt_input" id="dt_input_{{forloop.counter}}">
                            <input type="hidden" name="{{questionForm.response.html_name}}" id="{{questionForm.response.auto_id}}" value='{{questionForm.response.value}}'/>
                            <input type="hidden" name="column_headers" id="dt_col_headers_{{forloop.counter}}" value="{{questionObj.options}}"/>
                            <table class="table table-condensed table-bordered inner_table" id="dt_table_{{forloop.counter}}">
                              <thead>
                              </thead>
                              <tbody>
                              </tbody>
                            </table>
                          </div>
                        {% endif %}
                      {% endif %}
                    </div>

                    <div class="error">
                      {% if field_type == 'FI' %}
                        {{questionForm.responseFile.errors}}
                      {% else %}
                        {{questionForm.response.errors}}
                      {% endif %}
                    </div>

                    {% if instance.status == 'F' or instance.status == 'A' %}
                      <div class="feedback">
                        <label>Feedback:</label>
                        <div class="text">{{questionForm.instance.id|getFeedback}}</div>
                      </div>
                    {% endif %}
                  </div>
                  {% if forloop.last %}
                    <hr>
                  {% else %}
                    <hr class="light">
                  {% endif %}

                {% else %}
                <!-- SURVEY SECTION -->
                  <table class="likert">
                    <tbody>
                      <tr class="likert-item assignment_input" tabindex="-1">
                        <td class="likert-number">
                          {{questionForm.id}}
                          {{questionForm.nested.management_form}}
                          {{questionForm.nested.id}}
                          {{forloop.counter}}.
                        </td>
                        <td class="likert-prompt">
                            {{questionObj.question_text|inline_style|safe}}
                            {{questionForm.curriculum_question.as_hidden}}
                            {{questionForm.save.as_hidden}}
                        </td>
                        {% for option in questionObj.options|splitlines%}
                          <td class="likert-option">
                            {% if option|slugify == questionForm.response.value|slugify %}
                              <input type="radio" name="{{questionForm.response.html_name}}" id="{{questionForm.response.auto_id}}" value="{{option}}"  checked="true"/>
                            {% else %}
                              <input type="radio" name="{{questionForm.response.html_name}}" id="{{questionForm.response.auto_id}}" value="{{option}}" />
                            {% endif %}
                          </td>
                        {% endfor %}
                      </tr>
                    </tbody>
                  </table>
                {% endif %}
              {% endwith %}
              {% endwith %}
            {% endfor %}
          </div>
        </div>

        <div class="save-buttons">
          {% if form and form.instance.step.order > 1 %}
            <a class="back" href="javascript:waitForSave('{% url 'ctstem:resumeAssignment'  form.instance.instance.assignment.id form.instance.instance.id form.instance.step.order|add:'-1' %}')" onclick="return saveStep('{{form.instance.instance.status}}');">
              <button type="button" class="light back" id="bk">Back</button>
            </a>
          {% endif %}

          {% if form and form.instance.step.order != total_steps %}
            {% if instance.status == 'S' or instance.status == 'F' or instance.status == 'A' %}
              <a href="{% url 'ctstem:resumeAssignment' form.instance.instance.assignment.id form.instance.instance.id form.instance.step.order|add:'1' %}">
                <button type="button" class="bright next">Next</button>
              </a>
            {% else %}
              <button type="button" class="light save" id="sv" title="Save" >
                Save
              </button>
              <button type="button" class="bright submit" id="sc" title="Next Step" >
                Save &amp; Continue
              </button>
            {% endif %}
          {% else %}
            {% if instance.status == 'S' or instance.status == 'F' or instance.status == 'A' %}
              <a title="Next Step" href="{% url 'ctstem:home' %}">
                <button type="button" class="bright">Exit</button>
              </a>
            {% else %}
              <button class="light save" id="sv" title="Save" >
                Save
              </button>
              <button class="bright submit" id="sc" title="Submit Assignment">
                Submit
              </button>
            {% endif %}
          {% endif %}
          <input type="hidden" id="save" name="save" value="0"/>
        </div>

        </form>
      {% endif %}
    </div>
  </main>
  <!-- FOOTER -->
  <footer>
    <p>
      <!-- TODO: Come up with terms of use page! -->
      <a data-toggle="modal" data-target="#terms" class="terms" href="#">
      <span class="fa fa-creative-commons fa-2x" style="position: relative; top: 5px; margin-right: 2px;"></span> 2016.
      Some Rights Reserved</a>.
    </p>
    <p>
      This material was developed by the <a href="{% url 'ctstem:home' %}"> CT-STEM Project</a> at Northwestern University. <br>
      To inquire about using our material in your school or as part of research, please contact
      <a href="mailto:ct-stem@ccl.northwestern.edu">ct-stem@ccl.northwestern.edu</a>.
    </p>
    <p>
      This work was made possible through generous support from the National Science Foundation (grants CNS-1138461 and CNS 1441041) and the Spencer Foundation (Award #201600069). Any opinions, findings, or recommendations expressed in this material are those of the author(s) and do not necessarily reflect the views of the funding organizations.
    </p>
  </footer>
  <script type="text/javascript">

    var evt;
    document.onmousemove = function (e) {
      e = e || window.event;
      evt = e;
    }

    $("#assignmentForm input:checkbox").change(function(){
      var selectedValues = $("input[id="+$(this).attr('id')+"]:checked").map(function() {return this.value;}).get().join(',')
      var hiddenVar = $(this).prevAll('input:hidden');
      $(hiddenVar).val(selectedValues);
    });

    var allowPrompt = true;
    $(document).ready(function(){
      var status = "{{form.instance.instance.status}}";
      var closedStatus = ['S', 'F', 'A'];
      if(closedStatus.indexOf(status) >= 0){
        $(':input:not(:button)').attr('disabled', 'disabled');
      }
      else{
        window.onbeforeunload = function (e) {
          if(allowPrompt){
            var message = 'Important: Please click on \'Save\' button to leave this page.';
            return message;
          }
          else{
            allowPrompt = true;
          }
        };
      }
      loadCanvasData();
      loadDataTable();
    });

    $('a.page-link.linked').click(function(){
      allowPrompt = false;
    });
    $('div.save-buttons button').click(function(){
      allowPrompt = false;
    });

    //manual save
    $('button.save').click(function(){
      $('input:hidden[id="save"]').val(1);
      $('input:hidden[id*="save"][id*="form"]').val('on');
      setCanvasData();
      setDataTable();
      $('form#assignmentForm').submit();
    });

    //manual submit
    $('button.submit').click(function(){
      $('input:hidden[id="save"]').val(0);
      $('input:hidden[id*="save"][id*="form"]').val('');
      setCanvasData();
      setDataTable();
      $('form#assignmentForm').submit();
    });

    $('button.add_attachment').click(function() {
      var tr = $("tr:last", $(this).prev());
      cloneMore($(tr), $(this).attr('id'));
      //var new_row = $('div.attachment_table table.table tr:nth-last-child(2)');
      $(tr).toggle();
    });

    $('input[type="file"][id="selectedFile"]').change(function(){
      $("ul.messages li").remove();
      $("ul.messages").html('<li class="warning">Click the Save button below to Save the uploaded files</li>');
    })

    $('button.delete_attachment').click(function(){
      var r = confirm("Are you sure you want to delete this attachment?");
      if (r == true) {
        $(this).next('input').val('on');
        $(this).closest('tr').hide();
        $("ul.messages li").remove();
        $("ul.messages").html('<li class="warning">Click the Save button below to Delete the uploaded files</li>');
      }
    });

    function waitForSave(URL){
      setTimeout( function() { window.location = URL }, 1000 );
    }
    //ajax save on clicking the Back button or Page number
    function saveStep(status){
      if(status != 'S' && status != 'F' && status != 'A'){
        $('input:hidden[id="save"]').val(1);
        $('input:hidden[id*="save"][id*="form"]').val('on');
        setCanvasData();
        setDataTable();
        $('#assignmentForm').ajaxSubmit({
           dataType : 'json',
           success: function(data){
            return false;
           },
        });
      }
      return true;
    }

    function setCanvasData(){
      $('canvas.assignment_sketch').each(function(){
        var actions = $(this).sketch().actions;
        $(this).next().val(JSON.stringify(actions));
      });
    }

    function loadCanvasData(){
      $('canvas.assignment_sketch').each(function(){
        var id = '#'+$(this).attr('id');
        var actions = $(id).next().val();
        if(actions){
          var actions_json = JSON.parse(actions);
          $.each(actions_json, function (i, val) {
            $(id).sketch().actions.push(val);
            $(id).sketch().redraw();
          });
        }
      });
    }
    function setDataTable(){
      $('div.dt_input').each(function(){
        var tableId = $(this).children('table:first').attr('id');
        console.log('setting '+tableId);
        dtmSaveTable(tableId);
      });
    }
    function loadDataTable(){
      $('div.dt_input').each(function(){
        var divId = $(this).attr('id');
        var tableId = $(this).children('table:first').attr('id');
        //get row data
        var rowInput = $(this).children('input[type=hidden]:first').val();
        if (rowInput) {
          rowInput = JSON.parse(rowInput);
        }
        else {
          rowInput = '';
        }
        var colInput = $(this).children('input[type=hidden]:nth-of-type(2)').val().split('\n');
        var status = "{{form.instance.instance.status}}";
        var closedStatus = ['S', 'F', 'A'];
        var editFlag = true;
        if(closedStatus.indexOf(status) >= 0){
          editFlag = false;
        }
        dtmBuildHtmlTable(divId, tableId, colInput, rowInput, editFlag);
      });
    }


    //auto submit on focusout
    $(function(){
      {% if form.instance.instance.status != 'S' and form.instance.instance.status != 'F' and form.instance.instance.status != 'A'%}
        $('.assignment_input').focusout(function(e){
          if(evt.target.id == 'sv' ||  evt.target.id == 'sc' || evt.target.id == 'bk'){
            console.log('manual save');
            return false;
          }
          else{
            //alert('focus out');
            $('input:hidden[id="save"]').val(1);
            $('input:hidden[id*="save"][id*="form"]').val('on');
            setCanvasData();
            setDataTable();
            $('#assignmentForm').ajaxSubmit({
              dataType : 'json',
              success: function(data){
                //message at the top of the page stating responses auto saved
                $("ul.messages li").remove();
                $("ul.messages").html('<li class="success">'+data.message+'</li>');
                //change the url in the browser if new assignment
                if (history.pushState) {
                  var newurl = document.location.protocol +'//'+ document.location.host + data.url;
                  history.replaceState({},'',newurl);
                }
                //update question response ids for new assignment
                $('input:hidden[id^="id_form-"][id$="-id"]').each(function(){
                  var id = $(this).attr('id');
                  if(!($(this).val())){
                    $(this).val(data.questionResponses[id]);
                  }
                });
                $('input:hidden[id="id_form-INITIAL_FORMS"]').val(data.questionCount);

              },
              error: function(data) {
                $("ul.messages li").remove();
                $("ul.messages").html('<li class="error">The responses could not auto saved. Please click the Save or Save and Continue button at the bottom of the page.</li>');
              }
            });
            $('ul.messages').show();
            $('ul.messages').delay(30000).fadeOut('slow');
            return false;
          }
        });
      {% else %}
        $('canvas').each(function(){
          $(this)[0].removeEventListener('click');
        });
      {% endif %}
    });
  </script>

{% endblock %}

{% block footer %} {% endblock %}

