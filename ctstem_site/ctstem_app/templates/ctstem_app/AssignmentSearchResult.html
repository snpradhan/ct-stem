{% load ctstem_extras %}
{% block media %}
  {{ form.media }}
{% endblock %}
<table class="table table-bordered table-striped table-condensed inner_table">
  <thead>
    <tr>
      <th>Curriculum</th>
      <th>Assign</th>
    </tr>
  </thead>
  <tbody>
    {% for curriculum in curricula %}

      {% if curriculum.curriculum_type|slugify == 'Unit'|slugify %}
        <tr class="{% if forloop.counter|divisibleby:2 %} even {% else %} odd {% endif %}">
          <td>
            {{curriculum.curriculum_type}}: {{curriculum.title}}
            <span class="ec_lessons" id="unit_{{curriculum.id}}">
              <span><i class="fa fa-caret-square-o-down fa-lg" aria-hidden="true"></i></span>
              <span style="display:none;"><i class="fa fa-caret-square-o-up fa-lg" aria-hidden="true"></i></span>
            </span>
          </td>
          <td style="text-align:center;">
            {% if curriculum.underlying_curriculum_assigned > 0 %}
              <div class="assignment_status">{{curriculum.underlying_curriculum_assigned}}/{{curriculum.underlying_curriculum_count}} Lessons Assigned</div>
              {% if curriculum.underlying_curriculum_assigned < curriculum.underlying_curriculum_count %}
                <button class="btn btn-info select_assignment unit" id="{{curriculum.id}}" name="{{curriculum.title}}">
                Assign Remaining {{curriculum.underlying_curriculum_count|subtract:curriculum.underlying_curriculum_assigned}} Lessons</button>
              {% endif %}
            {% else %}
              <button class="btn btn-info select_assignment unit" id="{{curriculum.id}}" name="{{curriculum.title}}">Assign All {{curriculum.underlying_curriculum_count}} Lessons</button>
            {% endif %}
          </td>
        </tr>
        {% for curr in curriculum.underlying_curriculum %}
          <tr class="lesson unit_{{curriculum.id}} {% if forloop.parentloop.counter|divisibleby:2 %} even {% else %} odd {% endif %}">
            <td style="display:none;">&emsp;&emsp;&emsp;&emsp;Lesson: {{curr.title}}</td>
            <td style="display:none; text-align:center;">
              {% if curr.assigned|slugify == 'False'|slugify %}
                <button class="btn btn-info select_assignment lesson_{{curriculum.id}}" id="{{curr.id}}" name="{{curr.title}}">Assign Lesson</button>
              {% else %}
                <div class="assignment_status">Lesson Assigned</div>
              {% endif %}
          </td>
        </tr>
        {% endfor %}
      {% else %}
        <tr class="{% if forloop.counter|divisibleby:2 %} even {% else %} odd {% endif %}">
          <td>{{curriculum.curriculum_type}}: {{curriculum.title}}</td>
          <td style="text-align:center;">
            {% if curriculum.assigned|slugify == 'False'|slugify %}
              <button class="btn btn-info select_assignment" id="{{curriculum.id}}" name="{{curriculum.title}}">Assign</button>
            {% else %}
              <div class="assignment_status">{{curriculum.curriculum_type|title}} Assigned</div>
            {% endif %}
          </td>
        </tr>
      {% endif %}
    {% endfor %}
  </tbody>
</table>
<script type="text/javascript">
$(function (){

  //expand/collapse the underlying lessons
  $(".ec_lessons").click(function(){
    var id = $(this).attr('id');
    $(this).children().each(function(){
      $(this).toggle();
    });
    $('tr.lesson.'+id).children('td').each(function(){
      $(this).toggle();
    });
  });

  $("button.select_assignment").click(function(){
    //if assigning a Unit get and assign all the underlying published lessons
    var curriculum_name = $(this).attr('name');
    var group_class_id = "{{group_id}}";
    data = {}
    data['csrfmiddlewaretoken'] = $('#assignmentForm').find('input:hidden').eq(0).val();;
    var data = $.param(data);
    if(group_class_id){
      $.ajax({
        type: 'POST',
        url: '/assignment/add/'+$(this).attr('id')+'/'+group_class_id+'/',
        data: data,
        success: function(data){
          $('#assignmentMsg').addClass('success').html("Curriculum "+curriculum_name+" has been assigned");
        },
        error: function(xhr, ajaxOptions, thrownError){
          $('#assignmentMsg').removeClass('success').html("Something went wrong...");
        },
      });
      $(this).attr('disabled', 'disabled');
    }
    else{
      alert('Select a class to assign this curriculum to');
    }
  });
});

</script>
