{% extends "ctstem_app/base.html" %}
{% load ctstem_extras %}
{% block media %}
  {{ block.super }}
  {{ form.media }}
{% endblock %}

{% block title %}Class |{% endblock %}

{% block content %}
  {{block.super}}
  <div class="content">
    {% if form.instance.id %}
      <h2>Edit Class</h2>
    {% else %}
      <h2>Add New Class</h2>
    {% endif %}
    {% include "ctstem_app/Tabs.html" with tab='group' group=form.instance role='group'%}
    <form method="post" id="userGroupForm">
      {% csrf_token %}
      <div class="table" id="group">
        {{form.management_form}}
        <div class="form-group">
          <label for="id_group-title">{{ form.title.label }} {% if form.title.field.required %}(<span class="required">*</span>){% endif %} </label>
          <div class="controls">{{form.title}}</div>
          <div class="error">{{ form.title.errors }}</div>
        </div>
        <div class="form-group">
          <label for="id_group-subject">{{ form.subject.label }} {% if form.subject.field.required %}(<span class="required">*</span>){% endif %} </label>
          <div class="controls">{{form.subject}}</div>
          <div class="error">{{ form.subject.errors }}</div>
        </div>
        <div class="form-group">
          <label for="id_group-time">{{ form.time.label }} {% if form.time.field.required %}(<span class="required">*</span>){% endif %} </label>
          <div class="controls">{{form.time}}</div>
          <div class="error">{{ form.time.errors }}</div>
        </div>
        {% if user.teacher %}
          <input type="hidden" id="id_group-teacher" name="group-teacher" value="{{user.teacher.id}}"/>
        {% else %}
          <div class="form-group">
            <label for="id_group-teacher">{{ form.teacher.label }} {% if form.teacher.field.required %}(<span class="required">*</span>){% endif %} </label>
            <div class="controls">{{form.teacher}}</div>
            <div class="error">{{ form.teacher.errors }}</div>
          </div>
        {% endif %}
        <div class="form-group">
          <label for="id_group-description">{{ form.description.label }} {% if form.description.field.required %}(<span class="required">*</span>){% endif %} </label>
          <div class="controls">{{form.description}}</div>
          <div class="error">{{ form.description.errors }}</div>
        </div>
        <div class="form-group">
          <label for="id_group-group_code">{{ form.group_code.label }} {% if form.group_code.field.required %}(<span class="required">*</span>){% endif %} </label>
          <div class="input-group">
            {{form.group_code}}
            <span class="input-group-btn">
              <input type="button" class="btn btn-info" id="generate_code" value="Generate"/>
            </span>
          </div>
          <div class="error">{{ form.group_code.errors }}</div>
        </div>
        <div class="form-group">
          <label for="id_group-is_active">{{ form.is_active.label|title }} {% if form.is_active.field.required %}(<span class="required">*</span>){% endif %} </label>
          <div class="controls">{{form.is_active}}</div>
          <div class="error">{{ form.is_active.errors }}</div>
        </div>
        {% if form.instance.id %}
          <div class="form-group assignment_table">
            {{formset.management_form}}
            {{formset.id}}
            <div>
              <label for="id_assignment_table">Assignments (<span id="assignment_count">{{assignments|length}}</span>)</label>
            </div>
            {% if form.instance.is_active %}
            <div>
              <a type="button" class="btn btn-success assignment-modal" href="#" data-toggle="modal" data-target="#assignment" data-id="{{form.instance.id}}" data-title="{{form.instance.title}}" title="Search and Add Assignments">
                  <i class="fa fa-tasks"></i>
              </a>
            </div>
            {% endif %}

            <div class="table_container">
              <table class="table table-striped table-condensed table-bordered inner_table">
                <thead>
                  <tr>
                    <th style="width:75%;">Curriculum</th>
                    <th>Assigned On</th>
                    <th>Lock on Completion <i class="fa fa-info-circle" aria-hidden="true" title="When locked, students will be unable to open and view the assignment once they submit"></i></th>
                    <th>Delete</th>
                  </tr>
                </thead>
                <tbody>
                  {% for assignment in assignments %}
                    <tr id="{{assignment.id}}">
                      <td>
                        <div class="assignment_title">
                          {% with curriculum=assignment.curriculum %}
                            {% if curriculum.unit %}
                              <b>Unit:</b> {{curriculum.unit.title}} --
                            {% endif %}
                            <b>{{curriculum.get_curriculum_type_display}}:</b> {{curriculum.title}}
                          {% endwith %}
                        </div>
                      </td>
                      <td style="vertical-align:middle;">
                        {{assignment.assigned_date|date }}
                      </td>
                      <td class="lock_on_completion" style="text-align:center;">
                        <input type="checkbox" class="lock_assignment" {% if assignment.lock_on_completion %} checked {% endif %} data-id="{{assignment.id}}" data-title="{{assignment.curriculum.title}}" {% if not form.instance.is_active %} disabled {% endif %}/>
                      </td>
                      <td>
                        <!-- only allow assignments to be deleted if the class is active and the assignment in question is still New -->
                        {% if form.instance.is_active %}
                          {% if assignment.id|get_class_assignment_status == 'N' %}
                            <button type="button" class="btn btn-danger delete_assignment" name="delete_assignment" aria-label="Delete Assignment" title="Delete this Assignment" data-id="{{assignment.id}}" data-title="{{assignment.curriculum.title}}">
                              <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                            </button>
                          {% endif %}
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="form-group">
            <div>
              <label for="id_{{title}}"> Students (<span id="student_count">{{form.members.value|length}}</span>) </label>
            </div>
            <div>
              {% if form.instance.is_active %}
                <a type="button" class="btn btn-info upload-modal" href="#" data-toggle="modal" data-target="#studentSearch" data-id="{{form.instance.id}}" title="Search and Add existing Students to this class">
                  <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
                </a>
                <a type="button" class="btn btn-success upload-modal" href="#" data-toggle="modal" data-target="#upload" data-id="{{form.instance.id}}" data-title="{{form.instance.title}}" title="Upload new and existing Students to this class">
                  <i class="fa fa-user-plus"></i>
                </a>
                <a type="button" class="btn btn-info upload-modal" href="#" data-toggle="modal" data-target="#addStudent" data-id="{{form.instance.id}}" title="Create and Add new Student to this class">
                  <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                </a>

                {% if user.administrator %}
                  {% student_in_group_admin_actions %}
                {% else %}
                  {% student_in_group_teacher_actions %}
                {% endif %}
              {% endif %}
            </div>
            <div class="controls table_container">
              {{form.members.as_hidden}}
              <table class="table table-striped table-bordered table-condensed inner_table" id="members">
                <thead>
                  <tr>
                    <th width="3%" class="no-sort">
                      {% if form.instance.is_active %}
                        <input id="select-all" type="checkbox" value="0" name="select-all"/>
                      {% endif %}
                    </th>
                    <th> Username </th>
                    <th> Name </th>
                    <th> Email </th>
                    <th> Status </th>
                    <th> Student Consent </th>
                    <th> Parental Consent </th>
                    <th> Member Since</th>
                    <th> Last Login </th>
                  </tr>
                </thead>
                <tbody>
                  {% for x in form.members.value %}
                    {% with student=x|getStudentInfo %}
                    <tr id="{{student.id}}">
                      <td>
                        {% if form.instance.is_active %}
                          <input id="student_{{student.id}}" type="checkbox" class="action-select" value="{{student.id}}" name="student_{{student.id}}" />
                        {% endif %}
                      </td>
                      <td>{{student.user.username}}
                      {% if form.instance.is_active %}
                        <div class="controls">
                          <a type="button" class="btn btn-success edit" aria-label="Edit Student profile" title="Edit Student profile" href="{% url 'ctstem:userProfile' student.user.id %}">
                            <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
                          </a>
                          <a type="button" class="btn btn-warning removeUser" aria-label="Remove Student from this group" title="Remove Student from this group" href="{% url 'ctstem:removeStudent' form.instance.id student.id  %}" data-id="{{forloop.counter0}}">
                            <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                          </a>
                          <button type="button" class="btn btn-info reset_email" aria-label="Send password reset email" title="Send password reset email" onclick="return send_password_reset_email('{{student.user.username}}','{{csrf_token}}')">
                            <span class="glyphicon glyphicon-send" aria-hidden="true"></span>
                          </button>
                          {% if user.administrator or user.teacher %}
                            <button type="button" class="btn btn-gray reset" aria-label="Reset Student Password" title="Reset Student Password" onclick="return reset_password('{{student.user.get_full_name}}','{{student.user.id}}','{{csrf_token}}')">
                              <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>
                            </button>
                          {% endif %}
                        </div>
                      {% endif %}
                      </td>
                      <td>{{student.user.get_full_name}}</td>
                      <td>{{student.user.email}}</td>
                      <td>{{student.user.is_active|yesno:"Active,Inactive"}}</td>
                      <td>
                        {% if student.consent == 'A' %}
                          Agree
                        {% elif consent == 'D' %}
                          Disagree
                        {% else %}
                          Unknown
                        {% endif %}
                      </td>
                      <td>{{student.get_parental_consent_display}}</td>
                      <td>{{student.user.date_joined|date}} </td>
                      <td>{{student.user.last_login|date}}</td>
                    </tr>
                    {% endwith %}
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div class="error">{{ form.members.errors }}</div>
          </div>
        {% else %}
          <h4 class="warning"> Save the Class and then add Assignments and Students </h4>
          {{formset.management_form}}
          {{formset.id}}
          {{formset.as_hidden}}
        {% endif %}

        {% if form.instance.is_active %}
          <div class="form-group button-group-fixed">
            <input type="submit" class="btn btn-success" id="submit" value="Save Class"/>
          </div>
        {% endif %}
      </div>
    </form>
  </div>

  {% if form.instance.id %}
    {% block upload %}
      {% include "ctstem_app/UserUploadModal.html" %}
    {% endblock %}

    {% block assignment %}
      {% include "ctstem_app/AssignmentSearch.html" %}
    {% endblock %}

    {% block search_and_add_students %}
      {% include "ctstem_app/StudentSearch.html" %}
    {% endblock %}

    {% block create_and_add_student %}
      {% include "ctstem_app/CreateAndAddStudent.html" %}
    {% endblock %}

    {% block password_reset %}
      {% include "ctstem_app/UserPassword.html" %}
    {% endblock %}
  {% endif %}

  <script type="text/javascript">
    $(function (){

      $('button.delete_assignment').click(function(){
        var btn = $(this);
        var r = confirm("Are you sure you want to delete this assignment?");
        if (r == true) {
          var assignment_id = $(this).data('id');
          var url = '/assignment/delete/'+assignment_id+'/';
          $.ajax({
            type: 'GET',
            url: url,
            success: function(data){
              if(data['success'] == true){
                $(btn).closest('tr').hide();
              }
              else {
                alert("This assignment cannot be deleted.")
              }
            },
            error: function(){
              alert('error');
            }
          });

        }
      });

      $('a.upload-modal').click(function(){
        $("div.modal#upload select#id_group option:selected").prop('selected', false);
        $("div.modal#upload select#id_group option[value='"+$(this).data('id')+"']").prop('selected', true);
        $("div.modal#upload select#id_group").closest('.form-group').hide();
        $("div.modal#upload .modal-title span").html('<div>'+$(this).data('title')+'</div>');
      });

      $('.lock_assignment').on('click', function(){
        var flag = 0;
        var assignment_id = $(this).data('id');
        if($(this).is(':checked')){
          flag = 1;
        }
        var url = '/assignment/lock_on_completion/'+assignment_id+'/'+flag+'/';
        $.ajax({
          type: 'GET',
          url: url,
          success: function(data){
          },
          error: function(){
            alert('error');
          }
        });
      });

    });
  </script>
{% endblock %}
