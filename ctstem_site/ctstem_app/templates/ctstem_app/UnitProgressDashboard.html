{% extends "ctstem_app/base.html" %}
{% load ctstem_extras %}

{% block media %}
  {{ block.super }}
  {{ form.media }}
  <script src="https://code.highcharts.com/highcharts.js"></script>
{% endblock %}
{% block title %}Class Dashboard |{% endblock %}

{% block content %}
  {{block.super}}
 <div class="content teacher_detailed_dashboard" id="assignment_progress_dashboard">
    <h2> Unit Progress </h2>
    <div id="dashboard_header">
      <div class="navigation">
        {% with status=group.is_active|yesno:"active,inactive"%}
          <h5 class="left"><a href="{% url 'ctstem:teacherDashboard' teacher_id status %}"><i class="fas fa-chevron-left"></i><i class="fas fa-chevron-left"></i> Back to Teacher Dashboard</a></h5>
          &nbsp; &nbsp;&nbsp; &nbsp;
          <h5 class="left"><a href="{% url 'ctstem:teacherAssignmentDashboard' teacher_id status %}"><i class="fas fa-chevron-left"></i><i class="fas fa-chevron-left"></i> Back to All Assignments </a></h5>
        {% endwith %}
      </div>
      <div class="quick_links">
          <h5><a href="{% url 'ctstem:help' %}"><i class="far fa-question-circle"></i> Help </a></h5>
          <h5><a href="{% url 'ctstem:curriculatiles' %}?bucket=my_curricula">My Curricula</a></h5>
          <h5><a href="{% url 'ctstem:curriculatiles' %}?bucket=favorite_curricula"><i class="far fa-star"></i> Favorites</a></h5>
      </div>
    </div>
    <div class="legends_and_settings">
      <div class="legends_container">
        <h5 class="left">Legends</h5>
        <div class="legends">
          <div class="legend">
            <a type="button" class="btn tiny blue"> <i class="fas fa-tachometer-alt"></i></a>
            &nbsp;
            <label>Lesson Progress Dashboard</label>
          </div>
          <div class="legend">
            <a type="button" class="btn tiny blue"> <i class="fas fa-comment-dots"></i> </a>
            &nbsp;
            <label>Feedback Given</label>
          </div>
          <div class="legend">
            <a type="button" class="btn tiny blue"> <i class="far fa-comment-dots"></i> </a>
            &nbsp;
            <label>Feedback Pending</label>
          </div>
          <div class="legend">
            <a type="button" class="btn tiny blue"> <i class="fas fa-file-download"></i> </a>
            &nbsp;
            <label>Download Student Response</label>
          </div>
          <div class="legend">
            <a type="button" class="btn tiny blue"> <i class="fa fa-unlock" aria-hidden="true"></i> </a>
            &nbsp;
            <label>Unlock Assignment</label>
          </div>
          <div class="legend">
            <i class="far fa-window-minimize"></i>
            &nbsp;
            <label>Not Yet Started</label>
          </div>
          <div class="legend">
            <div class="crossed"></div>
            &nbsp;
            <label>Not Assigned</label>
          </div>
        </div>
      </div>
    </div>
    <form method="post" action="{% url 'ctstem:unitProgressDashboard' teacher_id %}" id="progress_search_form">
      {% csrf_token %}
      <div class="progress_filter">
        <div class="form-group">
          <label>{{filter_form.group.label|title}}</label>
          <div>{{filter_form.group}}</div>
        </div>
        <div class="form-group">
          <label>{{filter_form.assignment.label|title}}</label>
          <div>{{filter_form.assignment}}</div>
        </div>
        <div class="form-group">
          <label>{{filter_form.sort_by.label|title}}</label>
          <div>{{filter_form.sort_by}}</div>
        </div>
      </div>
    </form>
    {% if student_assignment_details %}
    <div class="dashboard_container">
      <table class="table table-bordered table-condensed" id="unit_progress">
        <thead>
          <tr>
            <th class="student_col">
              Student <br>
              {% if not user.researcher %}
                {% include "ctstem_app/AnonymizeStudentSwitch.html" with anonymize_student=anonymize_student assignment_ids=assignment_ids is_class_active=group.is_active %}
              {% endif %}
            </th>
            {% for curr, assignment in assignment_header.items %}
              <th class="lesson_{{curr.id}} top">
                {% if curr.order %}
                  Lesson {{curr.order}}
                  <a href="#" class="fa fa-info-circle info" rel="popover" data-title="Lesson {{curr.order}}" data-content="{{curr.title}}">
                  </a>
                {% endif %}
                <br>
                {% if assignment %}
                  <a class="btn blue" href="{% url 'ctstem:assignmentProgressDashboard' teacher_id %}?group={{group.id}}&assignment={{curr.id}}" title="Assignment Progress Dashboard for Lesson {{curr.order}}">
                    <i class="fas fa-tachometer-alt"></i>
                  </a>
                {% endif %}
              </th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for student, assignment_details in student_assignment_details.items %}
            <tr style="background-color: {% if forloop.counter|divisibleby:2 %}  white; {% else %} #f9f9f9; {% endif %}">
              <td class="student_col">
                <div class="student_name">
                  {% if user.researcher %}
                    <b>{{student.user.id}}</b><br>
                  {% else %}
                    <b>{{student}}</b><br>
                  {% endif %}
                </div>
                <div class="student_mask">
                  xxxxxxxxxxx
                </div>
              </td>
              {% for student_assignment in assignment_details %}
                {% if student_assignment.assignment is None %}
                  <td class="lesson_{{student_assignment.curriculum_id}}" style="width: 10em;">
                    <div class="crossed"></div>
                  </td>
                {% else %}
                  <td class="lesson_{{student_assignment.curriculum_id}}" style="width: 10em;">
                    <div class="assignment_status_chart">
                      <div id="chart_{{student_assignment.serial}}" class="donut_chart" name="{{student_assignment.percent_complete}}"></div>

                      {% if student_assignment.instance.status == 'P' %}
                        <!--div> In Progress </div-->
                        <div class="controls">
                           <a type="button" class="btn blue" href="{% url 'ctstem:assignmentStudentFeedback' teacher_id %}?group={{student_assignment.assignment.group.id}}&assignment={{student_assignment.assignment.curriculum.id}}&student={{student.user.id}}"
                          title="Give Feedback"> <i class="far fa-comment-dots" aria-hidden="true"></i> </a>
                        </div>
                      {% elif student_assignment.instance.status == 'S' %}
                        <!--div> Submitted </div-->
                        <div class="controls">
                          <a type="button" class="btn blue" href="{% url 'ctstem:assignmentStudentFeedback' teacher_id %}?group={{student_assignment.assignment.group.id}}&assignment={{student_assignment.assignment.curriculum.id}}&student={{student.user.id}}" title="Give Feedback"> <i class="far fa-comment-dots" aria-hidden="true"></i> </a>

                          <a type="button" class="btn blue" href="{% url 'ctstem:export_student_response' student_assignment.assignment.id  student.id %}" title="Download Student Response"> <i class="fas fa-file-download"></i> </a>
                          {% if student_assignment.instance.assignment.curriculum.curriculum_type == 'L' %}
                            <a type="button" class="btn blue" href="{% url 'ctstem:unlockAssignment' student_assignment.assignment.id  student_assignment.instance.id %}" title="Unlock Assignment" onclick="return confirm('Are you sure you want to unlock this assignment? Unlocking the assignment will allow the student to edit his/her responses and resubmit.');"> <i class="fa fa-unlock" aria-hidden="true"></i> </a>
                          {% endif %}
                        </div>
                      {% elif student_assignment.instance.status == 'F' %}
                        <!--div> Feedback Completed </div-->
                        <div class="controls">
                          <a type="button" class="btn blue" href="{% url 'ctstem:assignmentStudentFeedback' teacher_id %}?group={{student_assignment.assignment.group.id}}&assignment={{student_assignment.assignment.curriculum.id}}&student={{student.user.id}}" title="View/Give Feedback"> <i class="fas fa-comment-dots" aria-hidden="true"></i> </a>

                          <a type="button" class="btn blue" href="{% url 'ctstem:export_student_response' student_assignment.assignment.id  student.id %}" title="Download Student Response"> <i class="fas fa-file-download"></i> </a>
                        </div>
                      {% elif student_assignment.instance.status == 'A' %}
                        <!--div> Archived </div-->
                        <div class="controls">
                          <a type="button" class="btn blue" href="{% url 'ctstem:assignmentStudentFeedback' teacher_id %}?group={{student_assignment.assignment.group.id}}&assignment={{student_assignment.assignment.curriculum.id}}&student={{student.user.id}}" title="View/Give Feedback"> <i class="fas fa-comment-dots" aria-hidden="true"></i> </a>

                          <a type="button" class="btn blue" href="{% url 'ctstem:export_student_response' student_assignment.assignment.id  student.id %}" title="Download Student Response"> <i class="fas fa-file-download"></i> </a>
                        </div>
                      {% else %}
                        <i class="far fa-window-minimize"></i>
                      {% endif %}
                    </div>
                  </td>
                {% endif %}
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
  </div>

  <script type="text/javascript">

    $(window).resize(function(){
      adjustDashboardSize();
    });

    function adjustDashboardSize() {
      var minHeight = $(window).height() - $('.dashboard_container').offset().top;
      $('.dashboard_container').height(minHeight + 40);
    }
    adjustDashboardSize();

    $('#progress_search_form select, \
       #progress_search_form input[type=radio], \
       #progress_search_form input[type=checkbox]').on('change', function(){

      if($(this).attr('id') == 'id_group'){
        $('select#id_assignment').val('');
      }

      $('#progress_search_form').submit();
    });

    $(".info").click(function (e) {
      e.preventDefault();
      e.stopPropagation();
      $(".info").not(this).popover('hide');
    });

    $(document).click(function (e) {
      if (($('.popover').has(e.target).length == 0) || $(e.target).is('.close')) {
        $(".info").popover('hide');
      }
    });
    $(".info").popover({
      placement: 'bottom',
      html: true,
      container: 'body',
    });

    $('.donut_chart').each(function(){
      render_donut_chart($(this));
    });

  </script>

{% endblock %}


